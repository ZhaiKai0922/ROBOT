# GMapping理解

## 1. Rao-Blackwellized 粒子滤波

在定位问题中，每一个粒子只需要表示一个可能的姿态。但在SLAM中，姿态和地图都是变量，所以一个粒子需要同时保存所有历史时刻的机器人位姿和整个地图。

根据贝叶斯法则，有

![preview](/home/zk/zk/ROBOT/learn_gmapping/new_gmapping/v2-945b12dd6603aa4c4e20b28771a3823f_r.jpg)

这一分解相当于把SLAM分离为定位和建图两步，大大降低SLAM问题的复杂度。该处理方法称为Rao-Blackwellized粒子滤波（RBPF）。

这里通过上一个时刻的地图和运动模型预测当前的位姿，然后计算权重，即在当前位姿下得到当前观测的可能性，再进行重采样，进而更新粒子地图，如此往复。

## 2. 致命缺陷

上面介绍的RBPF方法理论上可行，但是实际却没法用。主要存在两个问题：

- 1. 建图对机器人位姿要求较高的要求，对任意一个粒子，仅仅依靠运动模型采样的结果构建地图，误差会非常大。如果粒子数量足够多，也行会有若干粒子得到准确的地图，但整体上来看，通过运动模型得到的提议分布（proposal distribution）太过于分散，与真实分布相差过大。要想提高真实分布附近的粒子数，就必须整体增加粒子，这会导致计算代价上升。
- 2. 频繁的重采样导致粒子耗散。每个粒子都包含了历史上所有的位姿和地图，频繁的重采样会使历史久远的位姿丧失多样性，因为重采样依赖的权重主要取决于当前观测。

GMapping正是针对这两处缺陷，提出了针对方案。

## 3. 改善方案

### 3.1 针对问题1：改善提议分布

粒子滤波采用里程计运动模型作为提议分布，导致大部分粒子都偏离真实位置。与运动模型相反，激光雷达的观测模型则可以给出一个相对集中的分布。如下图所示，如果把粒子采样范围从又扁又宽的区域更改到激光雷达观测模型所代表的尖峰区域L，新的粒子分布就更贴合真实分布。

<img src="" width = "500" height = "300" alt="1" align=center />

<img src="/home/zk/zk/ROBOT/learn_gmapping/new_gmapping/image-20201218155252540.png" width = "500" height = "300" alt="1" align=center />

**实现方案：**

- 首先按照里程计运动模型给出预测，图1中所有粒子通过里程计运动模型预测出新的位置如图2所示。

<img src="/home/zk/zk/ROBOT/learn_gmapping/new_gmapping/image-20201218155348597.png" width = "500" height = "260" alt="1" align=center />

- 以图2粒子的预测位置为初始值，对每一个粒子进行一次扫描匹配(scanMatch)。通过扫描匹配得到该粒子的最优位姿如图3，使得当前观测与该粒子所携带的地图最为贴合。

<img src="/home/zk/zk/ROBOT/learn_gmapping/new_gmapping/image-20201218162559110.png" width = "500" height = "260" alt="1" align=center />

- 得到每个粒子的最优位姿后，再在每个粒子的附近撒播k个粒子，用高斯函数来模拟提议分布如上图4所示，根据这k个粒子的里程计和观测模型来计算高斯分布均值和方差，如下图所示：

![preview](/home/zk/zk/ROBOT/learn_gmapping/new_gmapping/v2-5021b502d9927f1799d3d18b3df26a32_r.jpg)

- 新的粒子从高斯分布中采样得到

<img src="/home/zk/zk/ROBOT/learn_gmapping/new_gmapping/image-20201218170532653.png" width = "500" height = "260" alt="1" align=center />

- 此外，对于每个粒子，我们还需要赋予一个权值，以供后续的重采样步骤使用。权重的计算方式如下：

![preview](/home/zk/zk/ROBOT/learn_gmapping/new_gmapping/v2-af1962e28858cffecc03b24b9014c1ff_r.jpg)

这其实是一个全概率公式，考虑了K个可能出现在当前时刻的位姿，计算它们对当前观测贡献的加权平均。

### 3.2 针对问题2：限制重采样次数

为了避免粒子耗散，作者提出了限制重采样次数的策略。我们可以想象，当机器人持续探索未知区域，并且尚未发生回环的时候，由于针对问题1提议分布的改善，粒子多样性和准确度都维持在一个较高的水平。虽然累积误差始终在叠加，但在局部区域，可以认为粒子保持了较高的精度。此时，如果频繁的执行重采样，粒子的多样性会消失。

何时执行重采样，是一个值得思考的问题。应当明确，重采样的目的是抛弃那些明显远离真实值的粒子，增强那些离真实值近的粒子。如果所有的粒子都在真实值附近，且分布均匀，那么我们就没有理由执行重采样。在回环发生之前，即使有些粒子已经远离了真实值，但现有的观测不足以区分开正确的粒子和错误的粒子，因此这时候重采样是没有意义的。只有在回环发生之后，新的观测彻底拉开正确粒子与错误粒子权重差距，此时重采样才能起到应有的效果。

那么，如何才能知道回环是否发生呢？显然，GMapping没有回环检测的算法，但机智的作者给出了更加巧妙的实现方式。直接通过下式评估所有粒子权重的分散程度。

![img](/home/zk/zk/ROBOT/learn_gmapping/new_gmapping/v2-08da9548e086d829ec99e51700269e62_1440w.jpg)

Neff越大，粒子的权重差距越小。当Neff降低到某一个阈值以下，说明粒子的权重差距较大，即粒子的分布与真实分布差距很大，在粒子层面表现为某些粒子离真实值很近，而很多粒子离真实值较远。这正是回环发生时经常出现的情况，重采样就应该在此时进行。

参考论文：http://www2.informatik.uni-freiburg.de/~stachnis/pdf/grisetti07tro.pdf

参考文章：https://zhuanlan.zhihu.com/p/58442126

参考文章：https://zhuanlan.zhihu.com/p/57566566

---

---





