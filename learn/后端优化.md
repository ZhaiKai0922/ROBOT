# 后端优化

## 一. 概述

其实，对于一个建图系统来讲，有了后端才是有了核心。我们前面用了九篇文章来介绍了工程怎么建、前端里程计怎么搭，而且还专门用两篇文章调整了代码结构，虽然截止这篇文章之前，这个系统里面仍然只是实现了前端里程计功能，但代码的结构已经接近最终的状态了，各个模块分工明确，这些都为我们添加后端优化算法打下了好的基础。所以这次我们只是在上次的结构上往里填代码。

后端通过图优化实现消除累计误差的功能，目前有三个流行的库：g2o gtsam ceeres，此处我们选用g2o，它的一些介绍网上都有，如果不太了解，就先自行搜索一下把。按照我们之前的设计思路，程序设计应该具有扩展性，即如果换成其他库，应该做到不需要改动过多的代码就可以实现。执行这一思路的作用就是使用多态，即先用一个抽象类定义优化算法的接口，然后g2o作为它的子类实现这个接口。详细原理和做法在以前的文章里介绍过了。

g2o的原版库里，只提供了se3的顶点和边，我们这里要用gnss位置做观测，所以需要自己定义一个与观测相对应的边。

为了 保持模块的独立性，我们把优化算法的具体实现单独封装成一个模块，放在models文件夹中，back_end再调用这个模块。

## 二. 工程配置与文件结构

### 1. 工程配置

### 2. 文件结构

除了上面说的工程配置以外，我们把优化算法放在models/graph_optimizer文件夹下，接口类直接在文件夹一级目录里，g2o相关的封装放在models/graph_optimizer/g2o文件夹下。自定义的边放在models/graph_optimizer/g2o/edge文件夹下。这样层级分布应该还算明确。优化算法的调用仍然在之前介绍的back_end模块的back_end.cpp文件里。

## 三. 代码实现

详细来讲，此处的代码实现，重点包括三部分：一是g2o自定义边，二是g2o优化算法封装，三是back_end对优化算法的调用

### 1. g2o自定义边

这里需要定义的边是用来输入观测量的先验边。

kitti数据集可用的观测量包括GNSS位置和GNSS姿态两个，对这个问题，我们做一个小小的讨论。

前端里程计添加观测消除误差，其实就是一个融合，融合后的位姿用来拼接点云。在这样的任务里，对姿态观测准确度的要求要远大于对位置观测量准确度的要求。另一方面，GNSS组合导航系统中，位置观测往往都是有RTK高精度信息做基础的，相对更准确，而姿态是通过导航系统里对位置误差的观测反向推导的



